<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bài 03 - Music Player</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link rel="stylesheet" href="css/style.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; }

        /* Hiệu ứng xoay đĩa */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Dùng ID cover-img để áp dụng hiệu ứng */
        #cover-img.playing {
            animation: spin 8s linear infinite;
            transition: transform 0.5s ease-out; 
        }

        /* Định dạng thanh Visualizer (Equalizer) */
        .equalizer-bar {
            width: 6px; 
            background-color: #4f46e5; /* Màu indigo-600 */
            border-radius: 3px;
            height: 10px; /* Chiều cao mặc định */
            transition: height 0.1s ease-out; 
        }

        /* Tối ưu Thanh trượt (Progress Bar) */
        input[type=range] {
            -webkit-appearance: none;
            height: 6px; 
            background: #e5e7eb;
            border-radius: 3px;
            cursor: pointer;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #4f46e5;
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-900 via-purple-800 to-pink-700 min-h-screen font-sans">

    <header class="bg-white/90 backdrop-blur-md shadow sticky top-0 z-50 header-glass">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-indigo-700">Music Player</h1>
            <nav>
                <a href="index.html" class="text-gray-700 hover:text-indigo-600 font-medium transition-all-300">
                    <i data-lucide="home" class="inline w-4 h-4 mr-1"></i>Về Trang Chủ
                </a>
            </nav>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8">
            
            <div class="bg-white/95 backdrop-blur-sm p-6 rounded-2xl shadow-2xl flex flex-col items-center border border-white/20">
                <div class="w-64 h-64 bg-gray-200 rounded-full overflow-hidden mb-6 shadow-2xl border-4 border-white ring-4 ring-indigo-200">
                    
                    <img id="cover-img" src="images/avatar.jpg" alt="Cover" class="w-full h-full object-cover">
                </div>

                <h2 id="song-title" class="text-2xl font-bold text-gray-800 mb-1 text-center">Tên Bài Hát</h2>
                <p id="artist-name" class="text-indigo-500 mb-6">Nghệ sĩ</p>

                <audio id="audio-player"></audio>

                <div class="w-full mb-4">
                    <input type="range" id="progress" value="0" min="0" max="100" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600">
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span id="current-time">0:00</span>
                        <span id="duration">0:00</span>
                    </div>
                </div>

                <div class="flex items-center space-x-6 mb-8">
                    <button id="shuffle-btn" class="text-gray-400 hover:text-indigo-600 transition" title="Xáo trộn"><i data-lucide="shuffle"></i></button>
                    <button id="prev-btn" class="text-gray-600 hover:text-indigo-800 transition transform hover:scale-110"><i data-lucide="skip-back" class="w-8 h-8"></i></button>
                    
                    <button id="play-btn" class="bg-indigo-600 text-white p-4 rounded-full shadow-lg hover:bg-indigo-700 hover:scale-105 transition transform">
                        <i data-lucide="play" class="w-8 h-8 fill-current"></i>
                    </button>
                    
                    <button id="next-btn" class="text-gray-600 hover:text-indigo-800 transition transform hover:scale-110"><i data-lucide="skip-forward" class="w-8 h-8"></i></button>
                    <button id="repeat-btn" class="text-gray-400 hover:text-indigo-600 transition" title="Lặp lại"><i data-lucide="repeat"></i></button>
                </div>

                <div id="equalizer" class="h-16 flex items-end space-x-1 w-24 justify-center">
                </div>
            </div>

            <div class="bg-white/95 backdrop-blur-sm p-6 rounded-2xl shadow-2xl border border-white/20">
                <div class="mb-4 relative">
                    <input type="text" id="search-input" placeholder="Tìm kiếm bài hát..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all-300">
                    <i data-lucide="search" class="absolute left-3 top-2.5 text-gray-400 w-5 h-5"></i>
                </div>

                <h3 class="font-bold text-gray-700 mb-4 uppercase text-sm tracking-wider border-b pb-2">Danh Sách Phát</h3>
                
                <ul id="playlist" class="space-y-2 max-h-[400px] overflow-y-auto pr-2">
                    </ul>
            </div>
        </div>

        <section class="mt-12 bg-white/10 backdrop-blur-md p-6 rounded-xl border border-white/20 text-white">
            <h3 class="text-lg font-bold text-yellow-300 mb-2">Logic Tư Duy & Thuật Toán:</h3>
            <ul class="list-disc list-inside text-gray-100 space-y-1">
                <li><strong>Cấu trúc dữ liệu:</strong> Sử dụng mảng đối tượng (Array of Objects) để lưu trữ danh sách bài hát. Một biến con trỏ `currentIndex` dùng để theo dõi bài hát đang phát.</li>
                <li><strong>Xử lý Visualizer:</strong> Sử dụng `requestAnimationFrame` để tạo vòng lặp render animation (60fps) cập nhật chiều cao (height) của các thanh CSS ngẫu nhiên, mô phỏng hiệu ứng sóng nhạc mượt mà.</li>
                <li><strong>Quản lý sự kiện:</strong> Sử dụng `addEventListener` cho các nút điều khiển, thanh trượt thời gian và ô tìm kiếm.</li>
                <li><strong>Tìm kiếm:</strong> Sử dụng phương thức `filter()` và render lại danh sách bài hát theo từ khóa nhập vào.</li>
            </ul>
        </section>
    </main>

    <script>
        lucide.createIcons();

        // 1. Dữ liệu bài hát (Đã bổ sung danh sách 5 bài hát)
        const songs = [
            { title: "Em của ngày hôm qua", artist: "Sơn Tùng M-TP", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3", cover: "images/song1.jpg" },
            { title: "Âm thầm bên em", artist: "Sơn Tùng M-TP", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3", cover: "images/song2.jpg" },
            { title: "Sóng gió", artist: "Jack & K-ICM", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3", cover: "images/song3.jpg" },
            { title: "Cháu lên ba", artist: "Nhạc thiếu nhi", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3", cover: "images/song4.jpg" },
            { title: "Nơi này có anh", artist: "Sơn Tùng M-TP", src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3", cover: "images/song5.jpg" },
        ];

        // 2. State & DOM Elements
        let currentIndex = 0;
        let isPlaying = false;
        let isShuffle = false;
        let isRepeat = false;
        let visualizerAnimationId;

        const audio = document.getElementById('audio-player');
        const playBtn = document.getElementById('play-btn');
        const titleEl = document.getElementById('song-title');
        const artistEl = document.getElementById('artist-name');
        const coverImg = document.getElementById('cover-img'); // ID đã sửa
        const progress = document.getElementById('progress');
        const playlistEl = document.getElementById('playlist');
        const equalizerEl = document.getElementById('equalizer');
        const shuffleBtn = document.getElementById('shuffle-btn');
        const repeatBtn = document.getElementById('repeat-btn');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const searchInput = document.getElementById('search-input');
        const currentTimeEl = document.getElementById('current-time');
        const durationEl = document.getElementById('duration');


        // 3. Khởi tạo Visualizer (Equalizer)
        function initEqualizer() {
            equalizerEl.innerHTML = '';
            for(let i = 0; i < 12; i++) {
                const bar = document.createElement('div');
                bar.classList.add('equalizer-bar');
                // Height mặc định đã được set trong CSS
                equalizerEl.appendChild(bar);
            }
        }

        // Logic Visualizer Animation
        function animateVisualizer() {
            if(!isPlaying) {
                // Tắt animation và reset thanh về mặc định 5px
                Array.from(equalizerEl.children).forEach(bar => bar.style.height = '5px');
                return;
            }
            // Random chiều cao
            Array.from(equalizerEl.children).forEach(bar => {
                const h = Math.floor(Math.random() * 50) + 10;
                bar.style.height = `${h}px`;
            });
            visualizerAnimationId = requestAnimationFrame(animateVisualizer);
        }

        // 4. Load & Play Logic
        function loadSong(song) {
            titleEl.textContent = song.title;
            artistEl.textContent = song.artist;
            audio.src = song.src;
            // Dùng cover của bài hát, nếu không có thì dùng avatar.jpg
            coverImg.src = song.cover || 'images/avatar.jpg'; 
            renderPlaylist();
        }

        function playSong() {
            isPlaying = true;
            playBtn.innerHTML = '<i data-lucide="pause" class="w-8 h-8 fill-current"></i>';
            lucide.createIcons();
            audio.play();
            
            // Kích hoạt xoay đĩa thông qua class CSS
            coverImg.classList.add('playing');
            
            // Khởi động Visualizer
            if (visualizerAnimationId) cancelAnimationFrame(visualizerAnimationId);
            animateVisualizer();
        }

        function pauseSong() {
            isPlaying = false;
            playBtn.innerHTML = '<i data-lucide="play" class="w-8 h-8 fill-current"></i>';
            lucide.createIcons();
            audio.pause();
            
            // Dừng xoay đĩa
            coverImg.classList.remove('playing');
            
            // Dừng Visualizer
            if (visualizerAnimationId) cancelAnimationFrame(visualizerAnimationId);
            animateVisualizer();
        }

        // Định dạng thời gian
        const formatTime = (time) => {
            if (isNaN(time) || time < 0) return '0:00';
            const min = Math.floor(time / 60);
            const sec = Math.floor(time % 60);
            return `${min}:${sec < 10 ? '0' + sec : sec}`;
        }


        // 5. Render Playlist
        function renderPlaylist(filterText = '') {
            playlistEl.innerHTML = '';
            
            const filteredSongs = songs.filter(song => 
                song.title.toLowerCase().includes(filterText.toLowerCase()) ||
                song.artist.toLowerCase().includes(filterText.toLowerCase())
            );

            filteredSongs.forEach((song, index) => {
                // Tìm index thực của bài hát trong mảng songs gốc (quan trọng cho loadSong)
                const originalIndex = songs.findIndex(s => s.title === song.title && s.artist === song.artist);
                
                // Logic tạo class active
                const isActive = originalIndex === currentIndex;
                const activeClass = isActive 
                    ? 'bg-indigo-100 border-l-4 border-indigo-600 shadow-sm' 
                    : 'hover:bg-gray-50 border-l-4 border-transparent';
                        
                const li = document.createElement('li');
                li.className = `flex justify-between items-center p-3 rounded-r-lg cursor-pointer transition-all-300 ${activeClass}`;
                li.innerHTML = `
                    <div class="flex items-center space-x-3 truncate">
                        <span class="text-xs font-bold text-gray-400 w-4">${originalIndex + 1}</span>
                        <div class="truncate">
                            <p class="font-semibold text-gray-800 ${isActive ? 'text-indigo-700' : ''} truncate">${song.title}</p>
                            <p class="text-xs text-gray-500 truncate">${song.artist}</p>
                        </div>
                    </div>
                    ${isActive && isPlaying ? '<i data-lucide="bar-chart-2" class="text-indigo-600 w-5 h-5 animate-pulse flex-shrink-0"></i>' : ''}
                `;
                li.onclick = () => {
                    currentIndex = originalIndex;
                    loadSong(songs[currentIndex]);
                    playSong();
                };
                playlistEl.appendChild(li);
            });
            lucide.createIcons();
        }

        // 6. Events
        playBtn.addEventListener('click', () => isPlaying ? pauseSong() : playSong());

        prevBtn.addEventListener('click', () => {
            currentIndex = (currentIndex - 1 + songs.length) % songs.length;
            loadSong(songs[currentIndex]);
            playSong();
        });

        nextBtn.addEventListener('click', () => {
            if(isShuffle) {
                let newIndex;
                do {
                    newIndex = Math.floor(Math.random() * songs.length);
                } while (newIndex === currentIndex && songs.length > 1);
                currentIndex = newIndex;
            } else {
                currentIndex = (currentIndex + 1) % songs.length;
            }
            loadSong(songs[currentIndex]);
            playSong();
        });

        shuffleBtn.addEventListener('click', function() {
            isShuffle = !isShuffle;
            this.classList.toggle('text-indigo-600');
            this.title = isShuffle ? 'Xáo trộn ĐANG BẬT' : 'Xáo trộn ĐANG TẮT';
        });

        repeatBtn.addEventListener('click', function() {
            isRepeat = !isRepeat;
            this.classList.toggle('text-indigo-600');
            this.title = isRepeat ? 'Lặp lại ĐANG BẬT' : 'Lặp lại ĐANG TẮT';
            audio.loop = isRepeat; // Gán thuộc tính loop cho thẻ audio HTML
        });

        searchInput.addEventListener('input', (e) => {
            renderPlaylist(e.target.value);
        });

        // Audio Time Update
        audio.addEventListener('timeupdate', (e) => {
            const { duration, currentTime } = e.srcElement;
            if (isNaN(duration)) return;
            const progressPercent = (currentTime / duration) * 100;
            progress.value = progressPercent;
            
            currentTimeEl.textContent = formatTime(currentTime);
        });

        // Cập nhật tổng thời lượng khi dữ liệu tải xong
        audio.addEventListener('loadedmetadata', () => {
            durationEl.textContent = formatTime(audio.duration);
            progress.max = 100;
        });

        progress.addEventListener('input', () => {
            const duration = audio.duration;
            audio.currentTime = (progress.value / 100) * duration;
        });

        audio.addEventListener('ended', () => {
            // Logic chuyển bài đã được xử lý trong nextBtn.click()
            if (!isRepeat) {
                nextBtn.click();
            }
        });

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            initEqualizer();
            loadSong(songs[currentIndex]);
            lucide.createIcons();
        });
    </script>
</body>
</html>